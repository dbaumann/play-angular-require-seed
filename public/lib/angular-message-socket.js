/*! angular-message-socket 19-09-2014 */

!function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(){(function(){"use strict";var a=function(a,b){return function(){return a.apply(b,arguments)}};angular.module("dbaumann.message-socket",[]).factory("WebSocket",["$window",function(a){return a.WebSocket}]).provider("MessageSocket",["$logProvider",function(b){var c,d,e,f;return e="$variant",this.messageTypeKey=function(a){return e=a},f=1e3,this.reconnectTimeout=function(a){return f=a},d=10,this.maxReconnects=function(a){return d=a},c=25,this.delayedQueueSize=function(a){return c=a},void(this.$get=["$rootScope","$timeout","$window","$log","$q","WebSocket",function(g,h,i,j,k,l){var m,n,o;return n=function(){function a(a){this.queueSize=a,this.items=[]}return a.prototype.enqueue=function(a){return this.items.length===this.queueSize&&this.items.pop(),this.items.unshift(a)},a.prototype.dequeue=function(){return this.items.pop()},a.prototype.size=function(){return this.items.length},a}(),m=function(){function a(a,b,c){this.messenger=a,this.askMessage=b,this.responseTimeout=c,this.messageId=Date.now(),this.contextReceives=[],this.deferreds=[],this.tellSent=!1}return a.prototype["for"]=function(a){var b;return b=k.defer(),this.deferreds.push(b),this.tellSent||(this.messenger.tell(this.askMessage,this.messageId),this.tellSent=!0),this.contextReceives.push(this.messenger.receive(a,function(a){return function(c){return b.resolve(c),a.contextReceives.forEach(function(a){return a()}),h.cancel(a.timeoutPromise)}}(this))),this.timeoutPromise||(this.timeoutPromise=h(function(a){return function(){return a.contextReceives.forEach(function(a){return a()}),a.deferreds.forEach(function(b){return b.reject(new Error("[MessageSocket.AskTimedOut] Ask timeout for '"+a.askMessage[e]+"'"+(" elapsed after "+a.responseTimeout+" ms")))})}}(this),this.responseTimeout)),b.promise},a}(),o=function(){function k(k){this.receive=a(this.receive,this),this.handlers={},this.outbox=new n(c),this.uniqueId=function(){return"_"+Math.random().toString(36).substr(2,9)},this.onOpen=function(a){return function(){var b,c;if(a.connected=!0,a.reconnects=0,j.debug("MessageSocket opened."),a.outbox.size()){for(c=[];b=a.outbox.dequeue();)j.debug("MessageSocket sent",b[e],b),c.push(a.send(JSON.stringify(b)));return c}}}(this),this.onMessage=function(a){return function(b){var c,d,f,h,i;if(d=angular.fromJson(b.data),j.debug("MessageSocket received",d[e],d),null!=a.handlers[d[e]]){h=a.handlers[d[e]],i=[];for(f in h)c=h[f],i.push(g.$apply(function(){return c(d)}));return i}}}(this),this.reconnect=function(a){return function(){var c;return a.reconnects!==d?(c=Math.floor(Math.random()*Math.pow(2,a.reconnects)*f),j.debug("MessageSocket closed unexpectedly. Reconnecting in "+c+" ms."),h(function(){return a.reconnects+=1,a.connect(k)},c)):(g.$emit("MessageSocket.disconnected",Date.now()),b.debugEnabled()?void 0:i.alert("Your connection to this application has closed unexpectedly."))}}(this),this.onError=function(a){return j.debug("MessageSocket encountered an error",a)},this.connect(k)}return k.prototype.connected=!1,k.prototype.reconnects=0,k.prototype.connect=function(a){return this.socket=new l(a),this.socket.onopen=this.onOpen,this.socket.onmessage=this.onMessage,this.socket.onclose=function(a){return function(b){return a.connected=!1,b.wasClean?void 0:a.reconnect(b)}}(this),this.socket.onerror=this.onError,this.send=function(a){return this.socket.send(a)},i.onbeforeunload=function(a){return function(){return a.socket.close(),b.debugEnabled()?void 0:"Your connection to this application is about to close."}}(this)},k.prototype.receive=function(a,b){var c,d,e,f;if(!angular.isFunction(b))throw Error("expected function");for(angular.isString(a)&&(a=[a]),d=this.uniqueId(),e=0,f=a.length;f>e;e++)c=a[e],null==this.handlers[c]&&(this.handlers[c]={}),this.handlers[c][d]=b;return function(b){return function(){var e,f,g;for(g=[],e=0,f=a.length;f>e;e++)c=a[e],g.push(delete b.handlers[c][d]);return g}}(this)},k.prototype.tell=function(a,b){if(null==b&&(b=null),a._&&(a[e]=a._,delete a._),!a[e])throw Error("Missing message type");return a.stamp=b?b:Date.now(),this.connected?(j.debug("MessageSocket sent",a[e],a),this.send(JSON.stringify(a))):(j.debug("MessageSocket enqueued",a[e],a),this.outbox.enqueue(a)),a.stamp},k.prototype.withTimeout=function(a){return function(b){return new m(this,b,a)}},k}()}])}])}).call(this)},{}]},{},[1]);
